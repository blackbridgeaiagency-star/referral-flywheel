import logger from './lib/logger';

const { PrismaClient } = require('@prisma/client');
const prisma = new PrismaClient();

async function main() {
  logger.debug('='.repeat(80));
  logger.info(' REVENUE CALCULATION: CURRENT vs CORRECT APPROACH');
  logger.debug('='.repeat(80));
  logger.debug('');

  const creator = await prisma.creator.findFirst({
    where: { companyName: 'FitnessHub' },
    select: { id: true, companyName: true }
  });

  logger.debug(`Analyzing: ${creator.companyName}`);
  logger.debug('');

  // Get ALL members with their commissions
  const allMembers = await prisma.member.findMany({
    where: { creatorId: creator.id },
    select: {
      id: true,
      username: true,
      memberOrigin: true,
      subscriptionPrice: true,
      commissions: {
        where: { status: 'paid' },
        select: {
          saleAmount: true,
          creatorShare: true,
        },
      },
    },
  });

  // Separate organic vs referred
  const organicMembers = allMembers.filter(m => m.memberOrigin === 'organic');
  const referredMembers = allMembers.filter(m => m.memberOrigin === 'referred');

  // Calculate revenue for each group
  const organicRevenue = organicMembers.reduce((sum, member) => {
    const memberRevenue = member.commissions.reduce((s, c) => s + c.saleAmount, 0);
    return sum + memberRevenue;
  }, 0);

  const referredRevenue = referredMembers.reduce((sum, member) => {
    const memberRevenue = member.commissions.reduce((s, c) => s + c.saleAmount, 0);
    return sum + memberRevenue;
  }, 0);

  const totalRevenue = organicRevenue + referredRevenue;

  // Calculate MRR for each group
  const organicMRR = organicMembers.reduce((sum, m) => sum + (m.subscriptionPrice || 0), 0);
  const referredMRR = referredMembers.reduce((sum, m) => sum + (m.subscriptionPrice || 0), 0);
  const totalMRR = organicMRR + referredMRR;

  logger.debug('─'.repeat(80));
  logger.error('CURRENT APPROACH (WRONG)');
  logger.debug('─'.repeat(80));
  logger.debug('');
  logger.debug('Shows ALL revenue (organic + referred):');
  logger.debug(`  Total Revenue: $${totalRevenue.toFixed(2)}`);
  logger.debug(`  Monthly Revenue (MRR): $${totalMRR.toFixed(2)}`);
  logger.debug('');
  logger.debug('Problem: This includes revenue you would have had anyway!');
  logger.debug('         Doesn\'t show the VALUE of the referral app.');
  logger.debug('');

  logger.debug('─'.repeat(80));
  logger.info('CORRECT APPROACH (WHAT YOU WANT)');
  logger.debug('─'.repeat(80));
  logger.debug('');
  logger.debug('Show ONLY revenue from REFERRED members:');
  logger.debug(`  Total Revenue: $${referredRevenue.toFixed(2)} (from referrals)`);
  logger.debug(`  Monthly Revenue (MRR): $${referredMRR.toFixed(2)} (from referrals)`);
  logger.debug('');
  logger.debug('Benefit: Shows exactly how much extra money the app is generating!');
  logger.debug('         This is revenue you wouldn\'t have without referrals.');
  logger.debug('');

  logger.debug('─'.repeat(80));
  logger.info(' DETAILED BREAKDOWN');
  logger.debug('─'.repeat(80));
  logger.debug('');
  logger.debug('TOTAL MEMBERS:', allMembers.length);
  logger.debug(`├─ Organic:  ${organicMembers.length} (${(organicMembers.length/allMembers.length*100).toFixed(1)}%)`);
  logger.debug(`└─ Referred: ${referredMembers.length} (${(referredMembers.length/allMembers.length*100).toFixed(1)}%)`);
  logger.debug('');
  logger.debug('ALL-TIME REVENUE:', '$' + totalRevenue.toFixed(2));
  logger.debug(`├─ From Organic:  $${organicRevenue.toFixed(2)} (${(organicRevenue/totalRevenue*100).toFixed(1)}%) - Would have anyway`);
  logger.debug(`└─ From Referred: $${referredRevenue.toFixed(2)} (${(referredRevenue/totalRevenue*100).toFixed(1)}%) - ✨ Generated by app`);
  logger.debug('');
  logger.debug('MONTHLY RECURRING REVENUE (MRR):', '$' + totalMRR.toFixed(2));
  logger.debug(`├─ From Organic:  $${organicMRR.toFixed(2)} (${(organicMRR/totalMRR*100).toFixed(1)}%)`);
  logger.debug(`└─ From Referred: $${referredMRR.toFixed(2)} (${(referredMRR/totalMRR*100).toFixed(1)}%) - ✨ App's monthly value`);
  logger.debug('');

  // Calculate creator's take-home from referrals
  const referredCreatorShare = referredMembers.reduce((sum, member) => {
    const creatorEarnings = member.commissions.reduce((s, c) => s + c.creatorShare, 0);
    return sum + creatorEarnings;
  }, 0);

  logger.debug('─'.repeat(80));
  logger.info(' CREATOR\'S BENEFIT FROM REFERRAL APP');
  logger.debug('─'.repeat(80));
  logger.debug('');
  logger.debug(`Total Revenue Generated by App: $${referredRevenue.toFixed(2)}`);
  logger.debug(`Creator's 70% Share: $${referredCreatorShare.toFixed(2)}`);
  logger.debug(`Monthly Recurring from Referrals: $${referredMRR.toFixed(2)}/month`);
  logger.debug('');
  logger.debug('This is the EXTRA money the creator is making thanks to your app!');
  logger.debug('');

  logger.debug('─'.repeat(80));
  logger.info(' WHAT THE DASHBOARD SHOULD SHOW');
  logger.debug('─'.repeat(80));
  logger.debug('');
  logger.debug('Card 1: Total Revenue');
  logger.debug(`  Display: $${referredRevenue.toFixed(2)}`);
  logger.debug('  Label: "Revenue from Referrals" or "Referral-Generated Revenue"');
  logger.debug('  Subtitle: "Revenue generated by your referral program"');
  logger.debug('');
  logger.debug('Card 2: Monthly Revenue');
  logger.debug(`  Display: $${referredMRR.toFixed(2)}`);
  logger.debug('  Label: "Monthly Recurring from Referrals"');
  logger.debug('  Subtitle: "Ongoing monthly revenue from referred members"');
  logger.debug('');

  logger.debug('='.repeat(80));
  logger.info(' SUMMARY');
  logger.debug('='.repeat(80));
  logger.debug('');
  logger.debug('CHANGE NEEDED:');
  logger.debug('  ❌ OLD: Count ALL commissions (organic + referred)');
  logger.debug('  ✅ NEW: Count ONLY commissions from referred members');
  logger.debug('');
  logger.debug('WHY:');
  logger.debug('  - Shows the VALUE of the referral app');
  logger.debug('  - Demonstrates ROI for the creator');
  logger.debug('  - Tracks incremental revenue, not total revenue');
  logger.debug('');
  logger.debug('IMPACT FOR FITNESSHUB:');
  logger.debug(`  - Currently showing: $${totalRevenue.toFixed(2)} (misleading)`);
  logger.debug(`  - Should show: $${referredRevenue.toFixed(2)} (accurate app value)`);
  logger.debug(`  - Difference: $${(totalRevenue - referredRevenue).toFixed(2)} (organic, had anyway)`);
  logger.debug('');

  await prisma.$disconnect();
}

main().catch(console.error);
